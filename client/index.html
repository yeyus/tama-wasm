<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Tama.wasm</title>
    <script type="text/javascript" src="interface.js"></script>
    <script type="text/javascript" src="state.js"></script>
    <script type="text/javascript" src="lib/base64encode.mjs"></script>
    <script type="text/javascript" src="https://unpkg.com/pako@2.0.4/dist/pako.min.js"></script>
    <link rel="stylesheet" href="styles/main.css">
  </head>
  <body>
    <div class="tama">
      <div class="icon-bar">
        <img class="icon" src="assets/food.svg" alt="Food" data-icon=0 />
        <img class="icon" src="assets/lights.svg" alt="Light" data-icon=1 />
        <img class="icon" src="assets/games.svg" alt="Games" data-icon=2 />
        <img class="icon" src="assets/medicine.svg" alt="Medicine" data-icon=3 />
      </div>
      <canvas id="canvas" width="32" height="16"></canvas>
      <div class="icon-bar">
        <img class="icon" src="assets/bath.svg" alt="Bath" data-icon=4 />
        <img class="icon" src="assets/stats.svg" alt="Stats" data-icon=5 />
        <img class="icon" src="assets/discipline.svg" alt="Discipline" data-icon=6 />
        <img class="icon" src="assets/attention.svg" alt="Attention" data-icon=7 />
      </div>
    </div>
    
    
    
    <button id="singlestep">Single step</button>
    <button id="somesteps">Run 1000 steps</button>
    <button id="run1Hz">Run 1Hz steps</button>
    <button id="audioStart">Audio Start</button>
    <button id="coreDump">Core Dump</button>
    <label id="steps">Steps: <span>0</span></label>
    
    <button class="interface-btn" data-value="0">LEFT</button>
    <button class="interface-btn" data-value="1">MIDDLE</button>
    <button class="interface-btn" data-value="2">RIGHT</button>

    <memory-table></memory-table>
    <state-exporter></state-exporter>

    <script type="text/javascript">
      
      let interval = -1;
      let stepCount = 0;

      window.Module = {};
      Module.onRuntimeInitialized = () => {
        console.log('onRuntimeInitialized');
        const _run_for = Module.cwrap('u32t_tama_run_for');
        window.runFor = (ms = 33) => {
          stepCount += _run_for(ms);
        };

        const _step = Module.cwrap('void_tama_step');
        window.step = (n = 1) => {
          stepCount += n;
          _step(n);
        };

        window.pressButton = Module.cwrap('void_tama_button');

        window.getState = Module.cwrap('statet_tama_get_cpu_state', 'number', []);
        window.getStateSize = Module.cwrap('sizet_tama_get_cpu_state_size', 'number', []);

        window.emulationState = new EmulationState();
      };

      const stepCountLabel = document.querySelector('#steps>span');

      const UPDATE_RATE_MS = 33;
      document.getElementById('run1Hz').onclick = () => {
        interval = setInterval(() => {
          runFor(UPDATE_RATE_MS);
          stepCountLabel.innerHTML = stepCount;
        }, UPDATE_RATE_MS);
      };

      document.getElementById('audioStart').onclick = () => window.Tama.audioStart();

      const coreDump = () => {
        window.emulationState.pull(window.Module, window.getState, window.getStateSize);
        document.getElementsByTagName('memory-table')[0].update(window.emulationState);
      };

      /***** state-exporter *****/
      const exportFn = () => {
        window.emulationState.pull(window.Module, window.getState, window.getStateSize);
        return window.emulationState.export();
      }
      document.getElementsByTagName('state-exporter')[0].exportFn = exportFn;

      const importFn = (state) => {
        window.emulationState.import(state);
        window.emulationState.push(window.Module, window.getState, window.getStateSize);
        coreDump();
      }
      document.getElementsByTagName('state-exporter')[0].importFn = importFn;

      document.getElementById('coreDump').onclick = coreDump;
      
      document.getElementById('singlestep').onclick = () => {
        if (interval >= 0) clearInterval(interval);        
        step(1);
        coreDump()
        stepCountLabel.innerHTML = stepCount;
      };

      document.getElementById('somesteps').onclick = () => {
        if (interval >= 0) clearInterval(interval);        
        step(1000);
        coreDump();
        stepCountLabel.innerHTML = stepCount;
      };

      document.querySelectorAll('.interface-btn').forEach(btn => {
        const value = parseInt(btn.dataset.value, 10);
        btn.onmousedown = () => window.pressButton(value, 1);
        btn.onmouseup = () => window.pressButton(value, 0);
      });

      const canvas = document.getElementById('canvas');
      const canvasCtx = canvas.getContext('2d');
      canvasCtx.imageSmoothingEnabled = false;
      let icons = [];
      document.querySelectorAll('.icon-bar .icon').forEach(iconElement => {
        const index = parseInt(iconElement.dataset.icon, 10);
        icons[index] = iconElement;
      });

      window.Tama = new TamaObject();

      const updateLCD = () => {
        window.Tama.draw(canvasCtx, icons);
        window.requestAnimationFrame(updateLCD);
      };

      window.requestAnimationFrame(updateLCD);
    </script>
    <script type="text/javascript" src="../build/tama.js"></script>

    <!-- Components -->
    <script type="text/javascript" src="components/memory-table.js"></script>
    <template id="memory-table">
      <style>
        h1 {
          font-family: monospace;
          font-size: 2em;
        }

        table {
          font-family: monospace;
        }

        table tr {
          text-align: left;
        }

        td.zero {
          opacity: 0.6;
        }

        td.changed {
          background-color: blueviolet;
          color: white;
        }
      </style>
      <h1>CPU State</h1>

      <!-- CPU Registers -->
      <table>
        <tbody>
          <tr>
            <th>PC</th>
            <td data-interpolate="pc" data-interpolate-type="hex">0x0000</td>
            <th>NP</th>
            <td data-interpolate="np" data-interpolate-type="hex">0x00</td>
            <th>SP</th>
            <td data-interpolate="sp" data-interpolate-type="hex">0x00</td>
          </tr>
          <tr>
            <th>X</th>
            <td data-interpolate="x" data-interpolate-type="hex">0x0000</td>
            <th>Y</th>
            <td data-interpolate="y" data-interpolate-type="hex">0x0000</td>
            <th>A</th>
            <td data-interpolate="a" data-interpolate-type="hex">0x00</td>
            <th>B</th>
            <td data-interpolate="b" data-interpolate-type="hex">0x00</td>
          </tr>
          <tr>
            <th colspan="8">Flags</th>
          </tr>
          <tr>
            <th>C</th>
            <td data-interpolate="flags" data-interpolate-type="boolbin" data-interpolate-mask="1">0</td>
            <th>Z</th>
            <td data-interpolate="flags" data-interpolate-type="boolbin" data-interpolate-mask="2">0</td>
            <th>D</th>
            <td data-interpolate="flags" data-interpolate-type="boolbin" data-interpolate-mask="4">0</td>
            <th>I</th>
            <td data-interpolate="flags" data-interpolate-type="boolbin" data-interpolate-mask="7">0</td>
          </tr>
        </tbody>
      </table>

      <!-- Memory -->
      <table>
        <thead>
          <tr>
            <th>addr</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
            <th>8</th>
            <th>9</th>
            <th>A</th>
            <th>B</th>
            <th>C</th>
            <th>D</th>
            <th>E</th>
            <th>F</th>
          </tr>
        </thead>
        <tbody class="dump"></tbody>
      </table>
    </template>

    <script type="text/javascript" src="components/state-exporter.js"></script>
    <template id="state-exporter">
      <style>
        h1, textarea {
          font-family: monospace;
        }
        .actions {
          display: flex;
          flex-direction: row;
        }
      </style>
      <h1>State Exporter</h1>
      <div class="actions">
        <button id="export">Export</button>
        <button id="import">Import</button>
      </div>
      <textarea id="buffer"></textarea>
    </template>
  </body>
</html>